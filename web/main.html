<html>
    <body>
        <button type="button" id="btn-menu" style="position: absolute; left: 1808px; z-index: 3;">Menu</button>
        <div id="main-menu" style="position: absolute; top: 18px; left: 481px; width: 1884px; height: 900px; opacity: 0.9; z-index: 13; background-image: url('pics/menu.png'); background-size: contain; background-repeat: no-repeat;">
            <button type="button" id="btn-new-game" style="position: absolute; top: 300; left: 347px; z-index: 3;">New game</button>
            <input type="number" id="game-seed" style="position: absolute; top: 327; left: 347px; z-index: 3;" value=42></input>
        </div>
        <table>
            <tr><td><div id="input-box"></div></td></tr>
            <tr><td><div class="board-all">
                <table><tr><td style="position: relative; width: 125px;">
                        <table id="roundscorebonus-all" style="position: absolute; top: 0; z-index: 2;">
                            <tr><td>
                                <img style="height:55px; position: absolute; left: 57;" src="pics/rsb/13.png" id="rsb-lastround">
                                <img style="height:55px" src="pics/rsb/back.png" id="rsb-5">
                            </td></tr>
                            <tr><td><img style="height:55px" src="pics/rsb/back.png" id="rsb-4"></td></tr>
                            <tr><td><img style="height:55px" src="pics/rsb/back.png" id="rsb-3"></td></tr>
                            <tr><td><img style="height:55px" src="pics/rsb/back.png" id="rsb-2"></td></tr>
                            <tr><td><img style="height:55px" src="pics/rsb/back.png" id="rsb-1"></td></tr>
                            <tr><td><img style="height:55px" src="pics/rsb/back.png" id="rsb-0"></td></tr>

                            <tr><td><img style="height:55px" src="pics/book_action.png" id="book-action-0"></td></tr>
                            <tr><td><img style="height:55px" src="pics/book_action.png" id="book-action-1"></td></tr>
                            <tr><td><img style="height:55px" src="pics/book_action.png" id="book-action-2"></td></tr>

                            <tr><td><img style="height:55px" src="pics/market_0.png" id="market-action-0"></td></tr>
                            <tr><td><img style="height:55px" src="pics/market_1.png" id="market-action-1"></td></tr>
                            <tr><td><img style="height:55px" src="pics/market_2.png" id="market-action-2"></td></tr>
                            <tr><td><img style="height:55px" src="pics/market_3.png" id="market-action-3"></td></tr>
                            <tr><td><img style="height:55px" src="pics/market_4.png" id="market-action-4"></td></tr>
                            <tr><td><img style="height:55px" src="pics/market_5.png" id="market-action-5"></td></tr>
                        </table>
                    </td><td style="width: 425px; position: relative;">
                        <div id="inno-tablet" style="position: absolute; top: 0; background-image: url('pics/inno_tablet.png');width:423px;height: 198px; background-size: contain; background-repeat: no-repeat;">
                            <div id="inno-0" data=0 style="position: absolute; top: 18px; left: 64px; width: 84px; height: 52px; background-size: contain; background-repeat: no-repeat;"></div>
                            <div id="inno-1" data=1 style="position: absolute; top: 18px; left: 275px; width: 84px; height: 52px; background-size: contain; background-repeat: no-repeat;"></div>
                            <div id="inno-2" data=2 style="position: absolute; top: 132px; left: 11px; width: 84px; height: 52px; background-size: contain; background-repeat: no-repeat;"></div>
                            <div id="inno-3" data=3 style="position: absolute; top: 132px; left: 117px; width: 84px; height: 52px; background-size: contain; background-repeat: no-repeat;"></div>
                            <div id="inno-4" data=4 style="position: absolute; top: 132px; left: 222px; width: 84px; height: 52px; background-size: contain; background-repeat: no-repeat;"></div>
                            <div id="inno-5" data=5 style="position: absolute; top: 132px; left: 327px; width: 84px; height: 52px; background-size: contain; background-repeat: no-repeat;"></div>
                        </div>
                        <div id="tech-tablet" style="position: absolute; top: 187; background-image: url('pics/tech_tablet.png');width:425px;height: 238px; background-size: contain; background-repeat: no-repeat;">
                            <div id="tech-g0-p0" style="position: absolute; top: 57px; left: 42px; width: 47px; height: 45px;; background-size: contain; background-repeat: no-repeat;"></div>
                            <div id="tech-g0-p1" style="position: absolute; top: 119px; left: 42px; width: 47px; height: 45px;; background-size: contain; background-repeat: no-repeat;"></div>
                            <div id="tech-g0-p2" style="position: absolute; top: 180px; left: 42px; width: 47px; height: 45px;; background-size: contain; background-repeat: no-repeat;"></div>

                            <div id="tech-g1-p0" style="position: absolute; top: 57px; left: 147px; width: 47px; height: 45px;; background-size: contain; background-repeat: no-repeat;"></div>
                            <div id="tech-g1-p1" style="position: absolute; top: 119px; left: 147px; width: 47px; height: 45px;; background-size: contain; background-repeat: no-repeat;"></div>
                            <div id="tech-g1-p2" style="position: absolute; top: 180px; left: 147px; width: 47px; height: 45px;; background-size: contain; background-repeat: no-repeat;"></div>

                            <div id="tech-g2-p0" style="position: absolute; top: 57px; left: 253px; width: 47px; height: 45px;; background-size: contain; background-repeat: no-repeat;"></div>
                            <div id="tech-g2-p1" style="position: absolute; top: 119px; left: 253px; width: 47px; height: 45px;; background-size: contain; background-repeat: no-repeat;"></div>
                            <div id="tech-g2-p2" style="position: absolute; top: 180px; left: 253px; width: 47px; height: 45px;; background-size: contain; background-repeat: no-repeat;"></div>

                            <div id="tech-g3-p0" style="position: absolute; top: 57px; left: 358px; width: 47px; height: 45px;; background-size: contain; background-repeat: no-repeat;"></div>
                            <div id="tech-g3-p1" style="position: absolute; top: 119px; left: 358px; width: 47px; height: 45px;; background-size: contain; background-repeat: no-repeat;"></div>
                            <div id="tech-g3-p2" style="position: absolute; top: 180px; left: 358px; width: 47px; height: 45px;; background-size: contain; background-repeat: no-repeat;"></div>
                        </div>
                        <div id="round-boosters-all" style="position: absolute; top: 421px; width:425px;height: 173px;"></div>
                        <div id="rb-0-gold" style="position: absolute; top: 481px; left: 4px"></div>
                        <div id="rb-1-gold" style="position: absolute; top: 481px; left: 58px"></div>
                        <div id="rb-2-gold" style="position: absolute; top: 481px; left: 118px"></div>
                        <div id="palaces-all" style="position: absolute; top: 424px; left: 148px; width: 300;"></div>
                    </td><td>
                        <div id="field-all" style="position: relative; background-image: url('pics/field.jpg');width:902px;height: 605px; background-repeat: no-repeat; background-size: contain;">
                        </div>
                    </td><td style="position: relative;">
                        <div id="gods-all" style="background-image: url('pics/gods_back.png');width:380px;height: 605px; background-size: contain; background-repeat: no-repeat;">
                            <div id="neutral-god-0" style="position: absolute; background-image: url('pics/human.png'); width:32px; height: 35px; left: 1px; background-size: contain; background-repeat: no-repeat;" class="pcolor-neutral"></div>
                            <div id="neutral-god-1" style="position: absolute; background-image: url('pics/human.png'); width:32px; height: 35px; left: 100px; background-size: contain; background-repeat: no-repeat;" class="pcolor-neutral"></div>
                            <div id="neutral-god-2" style="position: absolute; background-image: url('pics/human.png'); width:32px; height: 35px; left: 196px; background-size: contain; background-repeat: no-repeat;" class="pcolor-neutral"></div>
                            <div id="neutral-god-3" style="position: absolute; background-image: url('pics/human.png'); width:32px; height: 35px; left: 289px; background-size: contain; background-repeat: no-repeat;" class="pcolor-neutral"></div>
                        </div>
                    </td>
                </tr>
                <tr><td colspan="5" style="position: relative;">
                    <table style="position: absolute; top: 0; left: 0; width: 1840;"><tr>
                        <td style="width: 115px;"></td>
                        <td style="width: 55px;" id="p0-booster"></td>
                        <td style="width: 572px;">
                            <div id="ptablet-0" style="position: relative; background-image: url('pics/tablet.png'); width:100%;height: 297px; background-size: contain; background-repeat: no-repeat;">
                                <div id="p0-race" style="position: absolute; top: 8px; left: 279px; width: 178px; height: 124px; background-size: contain;"></div>
                                <div id="p0-palace" style="position: absolute; top: 151px; left: 43px; width: 104px; height: 52px;; background-size: contain; background-repeat: no-repeat;"></div>
                                
                                <div id="p0-inno0" style="position: absolute; top: 208px; left: 462px; width: 104px; height: 70px; background-size: contain;"></div>
                                <div id="p0-inno1" style="position: absolute; top: 114px; left: 462px; width: 104px; height: 70px; background-size: contain;"></div>
                                <div id="p0-inno2" style="position: absolute; top: 20px; left: 462px; width: 104px; height: 70px; background-size: contain;"></div>

                                <div id="p0-mana0" style="position: absolute; top: 232px; left: 320px; width: 57px; height: 40px;"></div>
                                <div id="p0-mana1" style="position: absolute; top: 154px; left: 320px; width: 57px; height: 40px;"></div>
                                <div id="p0-mana2" style="position: absolute; top: 194px; left: 393px; width: 57px; height: 40px;"></div>

                                <div class="player-0">
                                    <div id="p0-b0-pos0" style="position: absolute; top: 259px; left: 60px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p0-b0-pos1" style="position: absolute; top: 259px; left: 86px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p0-b0-pos2" style="position: absolute; top: 259px; left: 112px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p0-b0-pos3" style="position: absolute; top: 259px; left: 138px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p0-b0-pos4" style="position: absolute; top: 259px; left: 164px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p0-b0-pos5" style="position: absolute; top: 259px; left: 190px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p0-b0-pos6" style="position: absolute; top: 259px; left: 216px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p0-b0-pos7" style="position: absolute; top: 259px; left: 242px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p0-b0-pos8" style="position: absolute; top: 259px; left: 268px; width: 18px; height: 23px; background-size: contain;"></div>

                                    <div id="p0-b1-pos0" style="position: absolute; top: 216px; left: 43px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p0-b1-pos1" style="position: absolute; top: 216px; left: 68px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p0-b1-pos2" style="position: absolute; top: 216px; left: 92px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p0-b1-pos3" style="position: absolute; top: 216px; left: 117px; width: 18px; height: 23px; background-size: contain;"></div>

                                    <div id="p0-b2-pos0" style="position: absolute; top: 164px; left: 84px; width: 18px; height: 23px; background-size: contain;"></div>

                                    <div id="p0-b3-pos0" style="position: absolute; top: 217px; left: 192px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p0-b3-pos1" style="position: absolute; top: 217px; left: 228px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p0-b3-pos2" style="position: absolute; top: 217px; left: 264px; width: 18px; height: 23px; background-size: contain;"></div>

                                    <div id="p0-b4-pos0" style="position: absolute; top: 159px; left: 217px; width: 18px; height: 23px; background-size: contain;"></div>
                                </div>

                                <div id="p0-passed" style="position: absolute; top: 19px; left: 123px; width: 277px; opacity: 0.0; height: 261px; background-size: contain; background-image: url('pics/passed.png');"></div>

                                <div id="p0-navLevel" class="player-0" style="position: absolute; top: 83px; left: 15px; width: 22px; height: 28px; background-size: contain; background-image: url('pics/marker.png');"></div>
                                <div id="p0-tfLevel" class="player-0" style="position: absolute; top: 80px; left: 206px; width: 22px; height: 28px; background-size: contain; background-image: url('pics/marker.png');"></div>

                                <div id="p0-score" style="position: absolute; top: 27px; left: 313px; color: white; font-weight: 900; font-size: 74px;">0</div>
                            </div>
                        </td><td style="width: 222px;">
                            <div id="presources-0"></div>
                        </td>
                        <td style="width: 55px;" id="p1-booster"></td>
                        <td style="width: 572px;">
                            <div id="ptablet-1" style="position: relative; background-image: url('pics/tablet.png');width:100%;height: 297px; background-size: contain; background-repeat: no-repeat;">
                                <div id="p1-race" style="position: absolute; top: 8px; left: 279px; width: 178px; height: 124px; background-size: contain;"></div>
                                <div id="p1-palace" style="position: absolute; top: 151px; left: 43px; width: 104px; height: 52px;; background-size: contain; background-repeat: no-repeat;"></div>

                                <div id="p1-inno0" style="position: absolute; top: 208px; left: 462px; width: 104px; height: 70px; background-size: contain;"></div>
                                <div id="p1-inno1" style="position: absolute; top: 114px; left: 462px; width: 104px; height: 70px; background-size: contain;"></div>
                                <div id="p1-inno2" style="position: absolute; top: 20px; left: 462px; width: 104px; height: 70px; background-size: contain;"></div>

                                <div id="p1-mana0" style="position: absolute; top: 232px; left: 320px; width: 57px; height: 40px;"></div>
                                <div id="p1-mana1" style="position: absolute; top: 154px; left: 320px; width: 57px; height: 40px;"></div>
                                <div id="p1-mana2" style="position: absolute; top: 194px; left: 393px; width: 57px; height: 40px;"></div>
                              
                                <div class="player-1">
                                    <div id="p1-b0-pos0" style="position: absolute; top: 259px; left: 60px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p1-b0-pos1" style="position: absolute; top: 259px; left: 86px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p1-b0-pos2" style="position: absolute; top: 259px; left: 112px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p1-b0-pos3" style="position: absolute; top: 259px; left: 138px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p1-b0-pos4" style="position: absolute; top: 259px; left: 164px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p1-b0-pos5" style="position: absolute; top: 259px; left: 190px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p1-b0-pos6" style="position: absolute; top: 259px; left: 216px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p1-b0-pos7" style="position: absolute; top: 259px; left: 242px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p1-b0-pos8" style="position: absolute; top: 259px; left: 268px; width: 18px; height: 23px; background-size: contain;"></div>

                                    <div id="p1-b1-pos0" style="position: absolute; top: 216px; left: 43px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p1-b1-pos1" style="position: absolute; top: 216px; left: 68px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p1-b1-pos2" style="position: absolute; top: 216px; left: 92px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p1-b1-pos3" style="position: absolute; top: 216px; left: 117px; width: 18px; height: 23px; background-size: contain;"></div>

                                    <div id="p1-b2-pos0" style="position: absolute; top: 164px; left: 84px; width: 18px; height: 23px; background-size: contain;"></div>

                                    <div id="p1-b3-pos0" style="position: absolute; top: 217px; left: 192px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p1-b3-pos1" style="position: absolute; top: 217px; left: 228px; width: 18px; height: 23px; background-size: contain;"></div>
                                    <div id="p1-b3-pos2" style="position: absolute; top: 217px; left: 264px; width: 18px; height: 23px; background-size: contain;"></div>

                                    <div id="p1-b4-pos0" style="position: absolute; top: 159px; left: 217px; width: 18px; height: 23px; background-size: contain;"></div>
                                </div>
                                
                                <div id="p1-passed" style="position: absolute; top: 19px; left: 123px; width: 277px; opacity: 0.0; height: 261px; background-size: contain; background-image: url('pics/passed.png');"></div>

                                <div id="p1-navLevel" class="player-1" style="position: absolute; top: 83px; left: 15px; width: 22px; height: 28px; background-size: contain; background-image: url('pics/marker.png');"></div>
                                <div id="p1-tfLevel" class="player-1" style="position: absolute; top: 80px; left: 206px; width: 22px; height: 28px; background-size: contain; background-image: url('pics/marker.png');"></div>

                                <div id="p1-score" style="position: absolute; top: 27px; left: 313px; color: white; font-weight: 900; font-size: 74px;">0</div>
                            </div>
                        </td><td style="width: 222px;">
                            <div id="presources-1"></div>
                    </td></tr></table>
                </td></tr>
                </table>
            </div>
            </td>
        </tr></table>
    </body>
    <head>
        <style>
            .highlight {
              border: 4px dashed black;
              /* background-color: rgb(161, 248, 180); */
            }
            .highlight:hover {
              border: 4px solid red;
            }

            .debug-border {
              border: 2px solid red;
            }

            .orange-border {
              border: 1px solid transparent;
            }
            .orange-border:hover {
              border: 3px solid orange;
            }

            .red-border {
              border: 3px solid transparent;
            }
            /* .red-border:hover {
              border: 3px solid red;
            } */

            .nonmoving-rect {
              position: absolute;
              width: 100%;
              height: 100%;
              top: 0;
              left: 0;
            }

            .crossed {
                filter: grayscale();
                border: none;
            }
            .crossed:hover {
                border: none;
            }

            .has-human {
              background-image: url('pics/human.png');
              background-size: contain;
              background-repeat: no-repeat;
              background-position: center;
            }

            .has-building-0 {
                background-image: url('pics/building_0.png');
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
            }
            .has-building-1 {
                background-image: url('pics/building_1.png');
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
            }
            .has-building-2 {
                background-image: url('pics/building_2.png');
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
            }
            .has-building-3 {
                background-image: url('pics/building_3.png');
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
            }
            .has-building-4 {
                background-image: url('pics/building_4.png');
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
            }
            .has-building-5 {
                background-image: url('pics/building_5.png');
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
            }
            .has-building-6 {
                background-image: url('pics/building_6.png');
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
            }

            .pcolor-0 {
                filter: hue-rotate(37deg) saturate(1.4) brightness(2.2);
            }
            .pcolor-1 {
            }
            .pcolor-2 {
                filter: grayscale() contrast(1.5) brightness(1.0);
            }
            .pcolor-3 {
                filter: hue-rotate(190deg) saturate(2.0) brightness(1.5);
            }
            .pcolor-4 {
                filter: hue-rotate(100deg) saturate(2.0) brightness(1.5);
            }
            .pcolor-5 {
                filter: grayscale() brightness(1.5);
            }
            .pcolor-6 {
                filter: hue-rotate(10deg) saturate(2.0) brightness(1.4);
            }
            .pcolor-neutral {
                filter: grayscale() contrast(1.3) brightness(3.5);
            }
                        
          </style>
        <!-- <style id="player-colors">
            .player-0: { filter: hue-rotate(10deg) saturate(2.0) brightness(1.4);}
            .player-1: { @extend .pcolor-` + pcolors[1] + `;}
        </style> -->

    <script type="text/javascript">
        const Buildings = [
            {
                "name": "Mine",
            },
            {
                "name": "Guild",
            },
            {
                "name": "Palace",
            },
            {
                "name": "Laboratory",
            },
            {
                "name": "Academy",
            },
            {
                "name": "Tower",
            },
            {
                "name": "Monument",
            },
        ]

        var actionFSM = [];
        var bridgables = [];
        var posByTile = [];
        var socket = new WebSocket('ws://localhost:9002');
        var gServerSocket = new WebSocket('ws://localhost:9102');
        var showMenu = true;
        
        function createLineElement(x, y, length, angle) {
            var line = document.createElement("div");
            var styles = 'border: 7px solid brown; '
                    + 'width: ' + length + 'px; '
                    + 'height: 0px; '
                    + 'transform: rotate(' + angle + 'rad); '
                    + 'position: absolute; '
                    + 'top: ' + y + 'px; '
                    + 'left: ' + x + 'px; ';
            line.setAttribute('style', styles);  
            return line;
        }
        function createLine(x1, y1, x2, y2, length) {
            var a = x1 - x2,
                b = y1 - y2,
                c = length;
                // c = Math.sqrt(a * a + b * b);

            var sx = (x1 + x2) / 2,
                sy = (y1 + y2) / 2;

            var x = sx - c / 2,
                y = sy;

            var alpha = Math.PI - Math.atan2(-b, a);

            return createLineElement(x, y, c, alpha);
        }
        function createBridge(hexFrom, hexTo) {
            if (hexFrom > hexTo) {
                tmp = hexTo;
                hexTo = hexFrom;
                hexFrom = tmp;
            }
            var bridgeId = "bridge-" + hexFrom + "-" + hexTo;
            if (!document.getElementById(bridgeId)) {
                const dv1 = document.getElementById("terrain-" + hexFrom);
                const dv2 = document.getElementById("terrain-" + hexTo);
                var line = createLine(dv1.offsetLeft + dv1.offsetWidth / 2, dv1.offsetTop + dv1.offsetHeight / 2, dv2.offsetLeft + dv2.offsetWidth / 2, dv2.offsetTop + dv2.offsetHeight / 2, 50);
                line.id = bridgeId;
                var dv = document.getElementById("field-all");
                dv.appendChild(line);
            }
        }

        function addImg(path, parent, wd, additionalClass) {
            var img = document.createElement('img');
            img.src = path
            img.width = wd
            if (additionalClass) {
                img.classList.add(additionalClass);
            }
            parent.appendChild(img)
            return img;
        }
        function addImgs(path, parent, amount, wd, additionalClass) {
            for (var i = 0; i < amount; i++) {
                addImg(path, parent, wd, additionalClass);
            }
        }

        function addGoldImgs(parent, amount, wd) {
            var amnt = amount;
            while (amnt >= 5) {
                addImg('pics/gold_5.png', parent, wd);
                amnt -= 5;
            }
            while (amnt >= 2) {
                addImg('pics/gold_2.png', parent, wd * 0.85);
                amnt -= 2;
            }
            while (amnt > 0) {
                addImg('pics/gold_1.png', parent, wd * 0.75);
                amnt --;
            }
        }

        function generateBoosterChoice(boosters) {
            var dv = document.querySelector("#input-box");
            dv.innerHTML = "Choose your round booster:";

            var idx = 0
            for (const rb of msg.boosters) {
                var img = document.getElementById("rb-" + idx);
                img.classList.add('highlight');
                img.data = idx;
                img.onclick = function() { socket.send('{ "choice": ' + this.data + '}'); document.querySelector("#input-box").innerHTML = ''; clearHighlight(); };
                idx++;
            }
        }

        function generateInputter(txt, img_width, img_prefix) {
            var dv = document.querySelector("#input-box");
            dv.innerHTML = '';

            var table = document.createElement('table');
            table.insertRow().insertCell().textContent = txt;
            var tr = table.insertRow();
            var td = tr.insertCell();
            td.style.width = 1900;

            for (const cIdx in msg.choices) {
                var img = document.createElement('img');
                td.appendChild(img);
                img.classList.add('highlight');
                img.style.width = img_width;
                // border: 1px solid transparent;
                img.src = img_prefix + cIdx + ".png"
                img.data = cIdx
                img.onclick = function() { socket.send('{ "choice": ' + this.data + '}'); document.querySelector("#input-box").innerHTML = ''; };
            }

            dv.appendChild(table);
        }

        function clearHighlight() {
            items = document.getElementsByClassName('highlight');

            while (items.length) {
                items[0].onclick = null;
                items[0].classList.remove('highlight');
            };
        }

        function visualizeSgs(gs) {
            const sgs = gs.staticGs;

            {
                var god = 0;            
                for (const teches of sgs.techTiles) {
                    var pos = 0;
                    for (const tileIdx of teches) {
                        var dv = document.getElementById("tech-g" + god + "-p" + pos);
                        posByTile[tileIdx] = god * 3 + pos;
                        dv.data = tileIdx;
                        dv.style.backgroundImage = "url('pics/tech/" + tileIdx + ".png')";
                        pos++;
                    }
                    god++;
                }
            }

            {
                var idx = 0;
                for (const rsb of sgs.bonusByRound) {
                    var dv = document.getElementById("rsb-" + idx);
                    if (idx < gs.round) {
                        dv.src = 'pics/rsb/back.png';
                    } else {
                        // dv.style.backgroundImage = "url('pics/rsb/" + rsb + ".png')";
                        dv.src = "pics/rsb/" + rsb + ".png";
                    }
                    idx++;
                }
                {
                    var dv = document.getElementById("rsb-lastround");
                    dv.src = "pics/rsb/" + sgs.lastRoundBonus + ".png";
                }
            }

            {
                const topByRank = [457, 413, 381, 339, 307, 264, 232, 190, 153, 124, 97, 66, 17];
                for (var idx = 0; idx < 4; idx++) {
                    var dv = document.getElementById("neutral-god-" + idx);
                    dv.style.top = topByRank[sgs.neutralGods[idx]];
                }
            }
        }

        function visualizePs(ps, gs, pIdx) {
            const res = ps.resources;
            const sgs = gs.staticGs;
            const pcolor = sgs.playerColors[pIdx];
            // resources
            {
                var dv = document.getElementById("p" + pIdx + "-score");
                dv.innerHTML = res.winPoints;
            }

            for (let i = 0; i < 4; i++) {
                var dv = document.getElementById("god-human-img-p" + pIdx + "-r" + res.gods[i] + "-g"  + i);
                dv.classList.add('has-human');
            }

            {
                var dv = document.getElementById("presources-" + pIdx);
                dv.innerHTML = "";

                const aic = ps.additionalIncome;
                dv.innerHTML += "income: gld: " + aic.gold + ", cube: " + aic.cube + ", hum: " + aic.humans + ", god: " + aic.anyGod + ", bks: " + aic.anyBook + ", mana: " + aic.manaCharge + ", wp: " + aic.winPoints + "<br>";
                
                addGoldImgs(dv, res.gold, 35);
                dv.innerHTML += " (" + res.gold + ")<br>";
                addImgs("pics/cube.png", dv, res.cube, 25);
                dv.innerHTML += " (" + res.cube + ")<br>";
                addImgs("pics/human.png", dv, res.humans, 25, "player-" + pIdx);
                dv.innerHTML += " (" + res.humans + "/" + ps.humansLeft + ")<br>";
                for (let i = 0; i < 4; i++) {
                    addImgs("pics/book_" + i + ".png", dv, res.books[i], 35);
                }
                for (let i = 0; i < ps.annexLeft; i++) {
                    var img = addImg("pics/annex.png", dv, 25);
                    img.id = "p" + pIdx + "-annex";
                }
                dv.appendChild(document.createElement("br"));
                
                for (let tileIdx = 0; tileIdx < 12; tileIdx++) {
                    if (ps.techTiles[tileIdx] != 0) {
                        addImg("pics/tech/" + tileIdx + ".png", dv, 70);
                    }
                }

                for (const tile of ps.feds) {
                    if (!tile.flipped) {
                        addImg("pics/fed_" + tile.origin + ".png", dv, 60);
                    } else {
                        addImg("pics/fed_back.png", dv, 60);
                    }
                }
                dv.appendChild(document.createElement("br"));

                {
                    var idx = 0;
                    for (const tile of ps.buttons) {
                        var img = addImg("pics/button_" + tile.buttonOrigin + ".png", dv, 60);
                        img.id = "p" + pIdx + "-button-" + idx;
                        img.data = idx;
                        if (tile.isUsed) {
                            img.classList.add("crossed");
                        }
                        idx++;
                    }
                }
                if (ps.boosterButton.buttonOrigin >= 0) {
                    var img = addImg("pics/button_" + ps.boosterButton.buttonOrigin + ".png", dv, 60);
                    img.id = "p" + pIdx + "-button--1";
                    img.data = -1;
                    if (ps.boosterButton.isUsed) {
                        img.classList.add("crossed");
                    }
                }

                dv.appendChild(document.createElement("br"));
                dv.innerHTML += "bridges: " + ps.bridgesLeft + "<br>";
            }

            {
                for (let i = 0; i < 3; i++) {
                    var dv = document.getElementById("p" +pIdx + "-mana" + i);
                    dv.innerHTML = "";
                    addImgs("pics/mana.png", dv, ps.mana[i], 14)
                }
            }
            {
                if (ps.palaceIdx >= 0) {
                    var dv = document.getElementById("p" + pIdx + "-palace");
                    dv.style.backgroundImage = "url('pics/palace/" + ps.palaceIdx + ".png')";
                }
            }
            {
                var innoIdx = 0;
                for (var tileIdx of ps.innovations) {
                    var dv = document.getElementById("p" + pIdx + "-inno" + innoIdx);
                    dv.style.backgroundImage = "url('pics/inno/" + tileIdx + ".png')";
                    innoIdx++;
                }
            }

            {
                const maxBuildings = [9, 4, 1, 3, 1];
                for (let bType = 0; bType < 5; bType++) {
                    var idx = 0;
                    while (idx < maxBuildings[bType] - ps.buildingsAvailable[bType]) {
                        var dv = document.getElementById("p" + pIdx + "-b" + bType + "-pos" + idx);
                        dv.style.backgroundImage = "";
                        idx++;
                    }
                    while (idx < maxBuildings[bType]) {
                        var dv = document.getElementById("p" + pIdx + "-b" + bType + "-pos" + idx);
                        dv.style.backgroundImage = "url('pics/occupied.png')";
                        idx++;
                    }
                }
            }
            
            {
                const topByLevel = [83, 62, 38, 14, 14];
                var dv = document.getElementById("p" + pIdx + "-navLevel");
                var dlevel = 0;
                if (pcolor == 3) { // Lake
                    dlevel = 1;
                }
                dv.style.top = topByLevel[ps.navLevel - dlevel];
            }
            {
                const topByLevel = [80, 54, 32, 32];
                var dv = document.getElementById("p" + pIdx + "-tfLevel");
                dv.style.top = topByLevel[ps.tfLevel];
            }

            {
                var dv = document.getElementById("p" + pIdx + "-passed");
                if(ps.passed > 0) {
                    dv.style.opacity = 0.75;
                } else {
                    dv.style.opacity = 0.0;
                }
            }
            {
                var dv = document.getElementById("p" + pIdx + "-booster");
                dv.innerHTML = "";
                addImg("pics/rb_" + ps.currentRoundBoosterOriginIdx + ".png", dv, 55);
            }

    // staticGs:
            {
                var dv = document.getElementById("p" + pIdx + "-race");
                dv.style.backgroundImage = "url('pics/race_" + sgs.playerRaces[pIdx] + ".png')";
            }
            {
                var dv = document.getElementById("ptablet-" + pIdx);
                dv.style.backgroundImage = "url('pics/tablets/" + pcolor + ".jpeg')";
            }
            
        // std::array<TerrainType, 2> playerColors = { (TerrainType) -1, (TerrainType) -1};
            
        }

        function visualizeGs(gs) {
            idx = 0
            pcolors = gs.staticGs.playerColors;

            const q = document.getElementById("player-colors");
            if ((!q) && (pcolors[0] > -1)) {
                var sheet = document.createElement('style')

                // Would be great to just copy given style, but I don't know how to do it
                const styleByColor = [
                    "{ filter: hue-rotate(37deg) saturate(1.4) brightness(2.2); }",
                    "{}",
                    "{ filter: grayscale() contrast(1.5) brightness(1.0); }",
                    "{ filter: hue-rotate(190deg) saturate(2.0) brightness(1.5); }",
                    "{ filter: hue-rotate(100deg) saturate(2.0) brightness(1.5); }",
                    "{ filter: grayscale() brightness(1.5); }",
                    "{ filter: hue-rotate(10deg) saturate(2.0) brightness(1.4); }"
                ]

                sheet.id = "player-colors";
                sheet.innerHTML = ".player-0 " + styleByColor[pcolors[0]] + "\n.player-1 " + styleByColor[pcolors[1]];
                document.head.appendChild(sheet);
            }

            {
                idx = 0
                for (building of gs.field.building) {
                    if (building.owner != -1) {
                        var dv = document.querySelector("#building_" + idx);
                        // dv.style.backgroundPosition = 'center';
                        dv.classList.add('has-building-' + building.type);
                        if (!building.neutral) {
                            dv.classList.add('player-' + building.owner);
                        } else {
                            dv.classList.add('pcolor-neutral');
                        }
                        if (building.hasAnnex) {
                            var img = document.createElement("img");
                            img.src = "pics/annex.png";
                            img.style.position = 'absolute';
                            img.style.width = 30;
                            dv.appendChild(img);
                        }
                    }
                    idx++;
                }
            }
            {
                for (var pos = 0; pos < 91; pos++) {
                    var dv = document.getElementById("terrain-" + pos);
                    if (gs.field.type[pos] != gs.field.basic_type[pos]) {
                        dv.style.backgroundImage = "url('pics/terrain/" + gs.field.type[pos] + ".png')";
                    } else {
                        dv.style.backgroundImage = "";
                    }
                }
            }
            {
                for (const idxPair of gs.field.bridgesHexes) {
                    createBridge(idxPair[0], idxPair[1]);
                }
            }
            
            {
                var dv = document.getElementById("round-boosters-all");
                dv.innerHTML = "";
                var idx = 0;
                for (var rb of gs.boosters) {
                    if (rb.originIdx >= 0) {
                        var img = addImg("pics/rb_" + rb.originIdx + ".png", dv, 42);
                        img.id = "rb-" + idx;
                        img.data = idx;
                        var goldDv = document.getElementById("rb-" + idx + "-gold");
                        if (goldDv) {
                            goldDv.innerHTML = "";
                            addGoldImgs(goldDv, rb.gold, 31);
                        }
                    }
                    idx++;
                }
            }
            {
                var idx = 0;
                for (var tileIdx of gs.innovations) {
                    var dv = document.getElementById("inno-" + idx);
                    if (tileIdx >= 0) {
                        dv.style.backgroundImage = "url('pics/inno/" + tileIdx + ".png')";
                    } else {
                        dv.style.backgroundImage = "";
                    }
                    idx++;
                }
            }

            {
                // var dv = document.getElementById("palaces-all");
                // dv.innerHTML = "";
                var dv = document.getElementById("round-boosters-all");
                // var idx = 0;
                for (var plc of gs.palacesAvailable) {
                    if (plc >= 0) {
                        var img = addImg("pics/palace/" + plc + ".png", dv, 140);
                        img.id = "palace-" + plc;
                    }
                    // idx++;
                }
            }

            {
                var god = 0;
                for (const hums of gs.humansOnGods) {
                    var pos = 0;
                    for (const owner of hums) {
                        if (owner >= 0) {
                            var dv = document.getElementById("god-bottom-img-g" + god + "-pos" + pos);
                            // dv.style.backgroundImage = "url('pics/human.png')";
                            dv.classList.add("has-human");
                            dv.classList.add("player-" + owner);
                        }
                        pos++;
                    }
                    god++;
                }
            }

            {
                for (var idx = 0; idx < 3; idx++) {
                    var dv = document.getElementById("book-action-" + idx);
                    dv.src = "pics/book_action/" + gs.bookActions[idx].picOrigin + ".png";
                    if (gs.bookActions[idx].isUsed) {
                        dv.classList.add("crossed");
                    } else {
                        dv.classList.remove("crossed");
                    }
                }
            }
            {
                for (var idx = 0; idx < 6; idx++) {
                    var dv = document.getElementById("market-action-" + idx);
                    if (gs.marketActions[idx].isUsed) {
                        dv.classList.add("crossed");
                    } else {
                        dv.classList.remove("crossed");
                    }
                }
            }

            for (let i = 0; i < 2; i++) {
                visualizePs(gs.players[i], gs, i);
            }

            visualizeSgs(gs);

            // j["playersOrder"] = gs.playersOrder;
            // j["fedTilesAvailable"] = toJson(gs.fedTilesAvailable);
            // j["phase"] = SC(gs.phase);
        }

        function generateFieldTable() {
            var dv = document.querySelector("#field-all");
            var table = document.createElement('table');
            var spaceTr1 = document.createElement('tr');
            spaceTr1.style.height = 26;
            table.appendChild(spaceTr1);

            var amounts = [10, 11, 10, 10, 9, 10, 10, 10, 11];
            var starts = [42, 5, 32, 65, 97, 62, 95, 51, 1];
            var widths = [61, 62, 63, 64, 65, 65, 66, 67, 69];
            var heights = [35, 36, 40, 41, 40, 42, 44, 44, 44];

            var curHex = 0;
            for (let r = 0; r < 9; r++) {
                var otr = document.createElement('tr');
                table.appendChild(otr);
                var otd = document.createElement('td');
                otr.appendChild(otd)
                var tbl = document.createElement('table');
                // tbl.border = 1;
                otd.appendChild(tbl);                

                var tr = document.createElement('tr');
                tbl.appendChild(tr);
                tr.style.height = heights[r];

                var spaceTd = document.createElement('td');
                spaceTd.style.width = starts[r];
                tr.appendChild(spaceTd);

                for (let i = 0; i < amounts[r]; i++) {
                    var hexTd = tr.insertCell();
                    var containerDv = document.createElement('div');
                    hexTd.appendChild(containerDv);

                    containerDv.style.width = widths[r];
                    containerDv.style.height = heights[r];
                    containerDv.style.position = 'relative';
                    containerDv.classList.add('red-border');
                    containerDv.id = "terrain-" + curHex;
                    
                    // containerDv.innerText = ".." + curHex;
                    // containerDv.style.fontSize = 36;

                    containerDv.style.backgroundSize = "contain";

                    var buildingDv = document.createElement('div');
                    containerDv.appendChild(buildingDv);
                    buildingDv.classList.add('nonmoving-rect');
                    buildingDv.id = 'building_' + curHex;

                    var highlightDv = document.createElement('div');
                    containerDv.appendChild(highlightDv);
                    
                    highlightDv.classList.add('nonmoving-rect');
                    highlightDv.style.height = heights[r];
                    highlightDv.style.zIndex = 10;
                    // highlightDv.style.opacity = 0.6;
                    highlightDv.id = 'fld_' + curHex;
                    highlightDv.data = curHex;

                    // hexTd.id = 'hex_' + curHex;
                    // hexTd.textContent = curHex;
                    // hexTd.style.fontSize = 40;
                    // hexTd.style.fontWeight = 'bold';
                    // hexTd.style.color = "white";
                    // hexTd.style.fontFamily = "Courier";
                    // hexTd.style.textAlign = "center";
                    // insideDv.onmouseover = function() { this.innerHTML = 'X'; };
                    // insideDv.onmouseout = function() { this.innerHTML = ''; };
                    curHex++;
                }
                var spaceTr = document.createElement('tr');
                table.appendChild(spaceTr);
                spaceTr.style.height = r / 2;
            }

            dv.appendChild(table);
        }

        function generateGodsTable() {
            var dv = document.querySelector("#gods-all");
            dv.style.position = "relative";

            {
                var humansOnGods = document.createElement('div');
                dv.appendChild(humansOnGods);
                humansOnGods.classList.add('nonmoving-rect');

                var topTable = document.createElement('table');
                humansOnGods.appendChild(topTable);

                var spaceTr1 = topTable.insertRow();
                spaceTr1.style.height = 10;
                
                spaceHs = [33, 1, 1, 0, 10, 15, 5, 15, 5, 12, 5, 12];

                for (let r = 0; r < 13; r++) {
                    var otr = topTable.insertRow();
                    otr.style.height = 22;
                    var spaceTd1 = otr.insertCell();
                    spaceTd1.style.width = 20;

                    for (let i = 0; i < 4; i++) {
                        for (let pIdx = 0; pIdx < 2; pIdx++) {
                            var otd = otr.insertCell();
                            otd.style.width = 20;

                            var dvP0 = document.createElement('div');
                            // dvP0.classList.add("has-human");
                            dvP0.classList.add("player-" + pIdx);
                            dvP0.id = "god-human-img-p" + pIdx + "-r" + (12-r) + "-g"  + i;
                            dvP0.style.width = 20;
                            dvP0.style.height = 22;
                            otd.appendChild(dvP0);
                        }

                        if (i < 3) {
                            var spaceTd = otr.insertCell();
                            spaceTd.style.width = 43;
                        }
                    }

                    var spaceTr = topTable.insertRow();
                    spaceTr.style.height = spaceHs[r];
                }
                
                var godsBottomTable = document.createElement("table");
                humansOnGods.appendChild(godsBottomTable);
                bottomSpaceTr1 = godsBottomTable.insertRow();
                bottomSpaceTr1.style.height = 5;

                bottomTr1 = godsBottomTable.insertRow();
                bottomTr1.style.height = 30;
                                
                for (let i = 0; i < 4; i++) {
                    var otdLeft = bottomTr1.insertCell();
                    otdLeft.style.width = 30;
                    otdLeft.style.position = "relative";
                    {
                        var dvP0 = document.createElement('div');
                        dvP0.style.width = 30;
                        // dvP0.classList.add("has-human");
                        dvP0.classList.add('nonmoving-rect');
                        dvP0.id = "god-bottom-img-g" + i + "-pos0";
                        dvP0.data = i;
                        otdLeft.appendChild(dvP0);
                    }

                    var spaceTd = bottomTr1.insertCell();
                    spaceTd.style.width = 11;

                    var otdRight = bottomTr1.insertCell();
                    otdRight.style.width = 30;
                    otdRight.style.position = "relative";
                    {
                        var dvP0 = document.createElement('div');
                        dvP0.style.width = 30;
                        dvP0.classList.add("has-human");
                        dvP0.classList.add("pcolor-neutral");
                        dvP0.classList.add('nonmoving-rect');
                        otdRight.appendChild(dvP0);
                    }

                    var spaceTd2 = bottomTr1.insertCell();
                    spaceTd2.style.width = 11;
                }

                bottomSpaceTr2 = godsBottomTable.insertRow();
                bottomSpaceTr2.style.height = 21;

                bottomTr2 = godsBottomTable.insertRow();
                bottomTr2.style.height = 30;

                for (let i = 0; i < 4; i++) {
                    var otdLeft = bottomTr2.insertCell();
                    otdLeft.style.width = 30;
                    otdLeft.style.position = "relative";
                    {
                        var dvP0 = document.createElement('div');
                        dvP0.style.width = 30;
                        // dvP0.classList.add("has-human");
                        dvP0.classList.add('nonmoving-rect');
                        dvP0.id = "god-bottom-img-g" + i + "-pos1";
                        dvP0.data = i;
                        otdLeft.appendChild(dvP0);
                    }

                    var spaceTd = bottomTr2.insertCell();
                    spaceTd.style.width = 11;

                    var otdRight = bottomTr2.insertCell();
                    otdRight.style.width = 30;
                    otdRight.style.position = "relative";
                    {
                        var dvP0 = document.createElement('div');
                        dvP0.style.width = 30;
                        // dvP0.classList.add("has-human");
                        dvP0.classList.add('nonmoving-rect');
                        dvP0.id = "god-bottom-img-g" + i + "-pos2";
                        dvP0.data = i;
                        otdRight.appendChild(dvP0);
                    }

                    var spaceTd2 = bottomTr2.insertCell();
                    spaceTd2.style.width = 11;
                }
            }
            {
                var godSelectors = document.createElement('div');
                dv.appendChild(godSelectors);
                godSelectors.classList.add('nonmoving-rect');

                var table = document.createElement('table');
                godSelectors.appendChild(table);
                
                var otr = table.insertRow();
                otr.style.height = 492;
                
                for (let i = 0; i < 4; i++) {
                    var otd = otr.insertCell();
                    otd.style.width = 75;
                    otd.style.position = 'relative';
                    otd.classList.add("red-border");
                    var dvP0 = document.createElement('div');
                    dvP0.classList.add('nonmoving-rect');
                    dvP0.id = "god-selector-" + i;
                    // dvP0.style.opacity = 0.4;
                    dvP0.data = i;
                    otd.appendChild(dvP0);

                    var spaceTd = otr.insertCell();
                    spaceTd.style.width = 10;
                }

                var otr2 = table.insertRow();
                otr2.style.height = 93;
                
                for (let i = 0; i < 4; i++) {
                    var otd = otr2.insertCell();
                    otd.style.width = 73;
                    otd.style.position = 'relative';
                    otd.classList.add("red-border");
                    var dvP0 = document.createElement('div');
                    dvP0.classList.add('nonmoving-rect');
                    dvP0.id = "god-humans-selector-" + i;
                    // dvP0.style.opacity = 0.4
                    dvP0.data = i;
                    otd.appendChild(dvP0);

                    var spaceTd = otr2.insertCell();
                    spaceTd.style.width = 11;
                }
            }
        }

        function genStartTable() {
            generateFieldTable();
            generateGodsTable();

            for (var i = 0; i < 6; i++) {
                var dv = document.getElementById("market-action-" + i);
                dv.data = i;
            }
            for (var i = 0; i < 3; i++) {
                var dv = document.getElementById("book-action-" + i);
                dv.data = i;
            }
        }

        function debugField(gs) {
            var idx = 0;
            for (const neibs of gs.field.adjacent) {
                var dv = document.getElementById("fld_" + idx);
                dv.neibs = neibs
                dv.onmouseenter = function() {
                    for (var nb of this.neibs) {
                        var nbDv = document.getElementById("fld_" + nb);
                        nbDv.classList.add("highlight");
                    }
                };
                dv.onmouseleave = function() { clearHighlight(); };

                idx++;
            }
        }

        function genFreeActionButtons(parent, ps) {
            const freeActions = ["ManaToHuman", "ManaToCube", "ManaToGold", "ManaToBook", "HumanToCube", "CubeToGold", "BookToGold", "BurnMana"];
            var idx = -1;
            for (const fa of freeActions) {
                var b = document.createElement("button");
                idx++;

                var enabled = true;
                if (fa == "ManaToHuman") {
                    if ((ps.mana[2] < 5) && (ps.humansLeft > 0)) {
                        enabled = false;
                    }
                } else if (fa == "BurnMana") {
                    if (ps.mana[1] < 2) {
                        enabled = false;
                    }
                } else if (fa == "ManaToCube") {
                    if (ps.mana[2] < 3) {
                        enabled = false;
                    }
                } else if (fa == "ManaToGold") {
                    if (ps.mana[2] < 1) {
                        enabled = false;
                    }
                } else if (fa == "ManaToBook") {
                    if (ps.mana[2] < 5) {
                        enabled = false;
                    }
                } else if (fa == "HumanToCube") {
                    if (ps.resources.humans < 1) {
                        enabled = false;
                    }
                } else if (fa == "CubeToGold") {
                    if (ps.resources.cube < 1) {
                        enabled = false;
                    }
                } else if (fa == "BookToGold") {
                    if (ps.resources.books[0] + ps.resources.books[1] + ps.resources.books[2] + ps.resources.books[3] < 1) {
                        enabled = false;
                    }
                }
                b.textContent = fa;
                b.data = idx;
                if (enabled) {
                    b.onclick = function() {
                        clearHighlight();
                        socket.send('{ "freeAction": ' + this.data + ' }');
                    };
                } else {
                    b.style.filter = 'sepia(1)';
                }
                parent.appendChild(b);
            }

            if (ps.mana[2] > 0) {
                var manaSpender = document.createElement('input');
                manaSpender.type = "checkbox";
                manaSpender.id = "spend-mana-to-gold";
                var label = document.createElement('label')
                label.htmlFor = "spend-mana-to-gold";
                label.appendChild(document.createTextNode("Spend 1 mana after action"));

                parent.appendChild(manaSpender);
                parent.appendChild(label);
            }
        }

        function sendActionFromFSM() {
            while (actionFSM.length < 3) {
                actionFSM.push(-1);
            }

            
            var result = '"type": ' + actionFSM[0] + ', "param1": ' + actionFSM[1] + ', "param2": ' + actionFSM[2];
            var dv = document.getElementById("spend-mana-to-gold");
            if (dv) {
                if (dv.checked) {
                    dv.checked = false;
                    result += ', "freeActionPost": 2';
                }
            }
            console.log("action: " + result);
            socket.send('{ ' +  result + '}');
        }

        function generateUpgradeChoices(gs, pos, upgrades) {
            const building = gs.field.building[pos].type;
            
            if (building == 0) sendActionFromFSM();
            if (building == 1) {
                for (const p of upgrades) {
                    if (p >= 0) {
                        var dv = document.getElementById("palace-" + p);
                        dv.classList.add('highlight');
                        dv.data = p;
                        dv.onclick = function() { actionFSM.push(this.data); clearHighlight(); sendActionFromFSM(); };
                    } else {
                        const tile = posByTile[-1 - p];
                        var dv = document.getElementById("tech-g" + Math.floor(tile / 3) + "-p" + (tile % 3));
                        dv.classList.add('highlight');
                        // dv.data = p;
                        dv.onclick = function() { actionFSM.push(-1 - this.data); clearHighlight(); sendActionFromFSM(); };
                    }
                }
            }
            if (building == 3) {
                for (const p of upgrades) {
                    var tile = posByTile[p];
                    var dv = document.getElementById("tech-g" + Math.floor(tile / 3) + "-p" + (tile % 3));
                    dv.classList.add('highlight');
                    // dv.data = tile;
                    dv.onclick = function() { actionFSM.push(this.data); clearHighlight(); sendActionFromFSM(); };
                }
            }
        }
        
        function generateBridgeChoices(firstPos) {
            var dv = document.getElementById("input-box");
            dv.innerHTML = 'Choose a place to bridge to';

            for (const p of bridgables[firstPos]) {
                var dv = document.getElementById("fld_" + p);
                dv.classList.add('highlight');
                dv.onclick = function() {
                    actionFSM.push(this.data);
                    clearHighlight();
                    socket.send('{ "from": ' + actionFSM[0] + ', "to": ' + actionFSM[1] + '}');
                };
            }
        }

        function generateAnnexChoices(choices) {
            for (const p of choices) {
                var dv = document.getElementById("fld_" + p);
                dv.classList.add('highlight');
                dv.onclick = function() { actionFSM.push(this.data); clearHighlight(); sendActionFromFSM(); };
            }
        }

        genStartTable()

        // Connection opened
        socket.addEventListener('open', function (event) {
            console.log('Connected to websocket server');
        });

        // Listen for messages
        socket.addEventListener('message', function (event) {
            showMenu = false;

            obj = JSON.parse(event.data);
            msg = JSON.parse(obj.msg);
            console.log('Received message:', obj.msg);

            visualizeGs(obj.gs);
            const pIdx = obj.gs.activePlayer;

            // debugField(obj.gs);
            bridgables = [];

            if (msg.action === 'chooseAction') {
                var prompt = document.getElementById("input-box");
                prompt.innerHTML = 'Choose action! Free market: ';
                actionFSM = [];
                var upgradesByPos = [];
                var annexPos = [];

                genFreeActionButtons(prompt, obj.gs.players[obj.gs.activePlayer]);
                
                for (const action of msg.variants) {
                    if (action.type == 0) { // UpgradeBuilding, // 0
                        var dv = document.getElementById("fld_" + action.param1);
                        if (!(action.param1 in upgradesByPos)) {
                            upgradesByPos[action.param1] = [];
                        }
                        upgradesByPos[action.param1].push(action.param2);
                        dv.classList.add('highlight');
                        dv.onclick = function() {
                            actionFSM.push(0);
                            actionFSM.push(this.data);
                            clearHighlight();
                            generateUpgradeChoices(obj.gs, this.data, upgradesByPos[this.data]);
                        };
                    } else if (action.type == 1) { // Market, // 1
                        var dv = document.getElementById("market-action-" + action.param1);
                        dv.classList.add('highlight');
                        dv.onclick = function() {
                            actionFSM.push(1);
                            actionFSM.push(this.data);
                            clearHighlight();
                            sendActionFromFSM();
                        };
                    } else if (action.type == 2) { // BookMarket, // 2
                        var dv = document.getElementById("book-action-" + action.param1);
                        dv.classList.add('highlight');
                        dv.onclick = function() {
                            actionFSM.push(2);
                            actionFSM.push(this.data);
                            clearHighlight();
                            sendActionFromFSM();
                        };
                    } else if (action.type == 3) { // ActivateAbility
                        var dv = document.getElementById("p" + pIdx + "-button-" + action.param1);
                        dv.classList.add('highlight');
                        dv.data = action.param1;
                        dv.onclick = function() {
                            actionFSM.push(3);
                            actionFSM.push(this.data);
                            clearHighlight();
                            sendActionFromFSM();
                        };
                    } else if (action.type == 4) { // PutManToGod
                        var dv;
                        if (action.param2 == 1) {
                            dv = document.getElementById("god-selector-" + action.param1);
                            dv.onclick = function() {
                                actionFSM.push(4);
                                actionFSM.push(this.data);
                                actionFSM.push(1);
                                clearHighlight();
                                sendActionFromFSM();
                            };
                        } else {
                            dv = document.getElementById("god-humans-selector-" + action.param1);
                            dv.onclick = function() {
                                actionFSM.push(4);
                                actionFSM.push(this.data);
                                actionFSM.push(0);
                                clearHighlight();
                                sendActionFromFSM();
                            };
                        }
                        dv.classList.add('highlight');
                    } else if (action.type == 5) { // GetInnovation
                        var dv = document.getElementById("inno-" + action.param1);
                        dv.classList.add('highlight');
                        dv.data = action.param1;
                        dv.onclick = function() {
                            actionFSM.push(5);
                            actionFSM.push(this.data);
                            clearHighlight();
                            sendActionFromFSM();
                        };
                    } else if (action.type == 6) { // TerraformAndBuild
                        var dv = document.getElementById("fld_" + action.param1);
                        dv.classList.add('highlight');
                        dv.onclick = function() {
                            actionFSM.push(6);
                            actionFSM.push(this.data);
                            actionFSM.push(1); // build mine immediately
                            clearHighlight();
                            sendActionFromFSM();
                        };
                    } else if (action.type == 7) { // UpgradeNav
                        var dv = document.getElementById("p" + pIdx + "-navLevel");
                        dv.classList.add('highlight');
                        dv.onclick = function() {
                            actionFSM.push(7);
                            clearHighlight();
                            sendActionFromFSM();
                        };
                    } else if (action.type == 8) { // UpgradeTerraform
                        var dv = document.getElementById("p" + pIdx + "-tfLevel");
                        dv.classList.add('highlight');
                        dv.onclick = function() {
                            actionFSM.push(8);
                            clearHighlight();
                            sendActionFromFSM();
                        };
                    } else if (action.type == 10) { // Annex
                        var dv = document.getElementById("p" + pIdx + "-annex");
                        annexPos.push(action.param1);
                        dv.classList.add('highlight');
                        dv.onclick = function() {
                            actionFSM.push(10);
                            clearHighlight();
                            generateAnnexChoices(annexPos);
                        };
                    } else if (action.type == 11) { // Pass
                        var dv = document.getElementById("rb-" + action.param1);
                        dv.classList.add('highlight');
                        dv.onclick = function() {
                            actionFSM.push(11);
                            actionFSM.push(this.data);
                            clearHighlight();
                            sendActionFromFSM();
                        };
                    }
                }
            }

            if (msg.action === 'triggerFinal') {
                var prompt = document.getElementById("input-box");
                prompt.innerHTML = 'The game is over!';
                socket.send('{}');
            }
            if (msg.action === 'chooseRace') {
                generateInputter("Choose your race:", 200, "pics/race_")
            }
            if (msg.action === 'chooseTerrainType') {
                generateInputter("Choose your terrain:", 200, "pics/terraintype_")
            }
            if (msg.action === 'chooseRoundBooster') {
                generateBoosterChoice(msg)
            }
            if (msg.action === 'chooseGodToMove') {
                var prompt = document.getElementById("input-box");
                prompt.innerHTML = 'Choose god to move';

                for (var i = 0; i < 4; i++) {
                    var dv = document.getElementById("god-selector-" + i);
                    dv.classList.add('highlight');
                    dv.onclick = function() { socket.send('{ "choice": ' + this.data + '}'); clearHighlight(); };
                }
            }
            if (msg.action === 'chooseBookColorToGet') {
                var prompt = document.getElementById("input-box");
                prompt.innerHTML = 'Choose book color to get, left: ' + msg.amount;

                for (var i = 0; i < 4; i++) {
                    var dv = addImg("pics/book_" + i + ".png", prompt, 50);
                    dv.classList.add('highlight');
                    dv.data = i;
                    dv.onclick = function() { socket.send('{ "choice": ' + this.data + '}'); clearHighlight(); };
                }
            }
            if (msg.action === 'chooseBooksToSpend') {
                var prompt = document.getElementById("input-box");
                prompt.innerHTML = 'Choose book color to SPEND, left: ' + msg.amount;

                for (const i of msg.colors) {
                    var dv = addImg("pics/book_" + i + ".png", prompt, 50);
                    dv.classList.add('highlight');
                    dv.data = i;
                    dv.onclick = function() { socket.send('{ "choice": ' + this.data + '}'); clearHighlight(); };
                }
            }
            if (msg.action === 'wannaBuildMine') {
                var prompt = document.getElementById("input-box");
                prompt.innerHTML = 'Do you want to build mine?';

                var hex = document.getElementById("fld_" + msg.coord);
                hex.classList.add('highlight');

                var dvYes = document.createElement('button');
                prompt.appendChild(dvYes);
                dvYes.innerHTML = "Yes";
                dvYes.onclick = function() { socket.send('{ "choice": 1}'); clearHighlight(); };
                
                var dvNo = document.createElement('button');
                prompt.appendChild(dvNo);
                dvNo.innerHTML = "No";
                dvNo.onclick = function() { socket.send('{ "choice": 0}'); clearHighlight(); };
            }
            if (msg.action === 'wannaCharge') {
                var prompt = document.getElementById("input-box");
                prompt.innerHTML = 'Do you want to charge ' + msg.amount + ' mana?';

                var dvYes = document.createElement('button');
                prompt.appendChild(dvYes);
                dvYes.innerHTML = "Yes";
                dvYes.onclick = function() { socket.send('{ "choice": 1}');};
                
                var dvNo = document.createElement('button');
                prompt.appendChild(dvNo);
                dvNo.innerHTML = "No";
                dvNo.onclick = function() { socket.send('{ "choice": 0}'); };
            }
            if (msg.action === 'chooseFedTile') {
                var prompt = document.getElementById("input-box");
                prompt.innerHTML = 'Choose federation tile: ';

                for (const tile of msg.variants) {
                    var img = document.createElement('img');
                    prompt.appendChild(img);
                    img.data = tile;
                    img.style.height = 100;
                    img.classList.add('highlight');
                    img.src = 'pics/fed_' + tile + '.png';
                    img.onclick = function() { socket.send('{ "choice": ' + this.data + '}'); };
                }
            }
            if (msg.action === 'chooseTechTile') {
                var prompt = document.getElementById("input-box");
                prompt.innerHTML = 'Choose tech tile!';

                for (const p of msg.variants) {
                    var tile = posByTile[p];
                    var dv = document.getElementById("tech-g" + Math.floor(tile / 3) + "-p" + (tile % 3));
                    dv.classList.add('highlight');
                    // dv.data = tile;
                    dv.onclick = function() { socket.send('{ "choice": ' + this.data + '}'); clearHighlight(); };
                }
            }
            if (msg.action === 'choosePlaceForBridge') {
                var dv = document.getElementById("input-box");
                dv.innerHTML = 'Choose a place to bridge from';
                actionFSM = [];

                for (const poses of msg.possiblePairs) {
                    if (!(poses[0] in bridgables)) bridgables[poses[0]] = [];
                    bridgables[poses[0]].push(poses[1])
                }

                for (const idx in bridgables) {
                    var dv = document.getElementById("fld_" + idx);
                    dv.classList.add('highlight');
                    
                    dv.onclick = function() {
                        actionFSM.push(this.data);
                        clearHighlight();
                        generateBridgeChoices(this.data);
                    };
                }
            }                        
            if (msg.action === 'choosePlaceToBuildForFree') {
                var dv = document.querySelector("#input-box");
                dv.innerHTML = 'Choose a place to build ' + Buildings[msg.building].name + ' for free';

                for (const idx of msg.choices) {
                    // var dv = document.querySelector("#fld_" + idx);
                    var dv = document.getElementById("fld_" + idx);
                    dv.classList.add('highlight');
                    
                    dv.onclick = function() { socket.send('{ "choice": ' + this.data + '}'); clearHighlight(); };
                }
            }
            if (msg.action === 'chooseBuildingToConvertForFree') {
                var dv = document.querySelector("#input-box");
                dv.innerHTML = 'Choose a building to convert into ' + Buildings[msg.building].name + ' for free';

                for (const idx of msg.choices) {
                    // var dv = document.querySelector("#fld_" + idx);
                    var dv = document.getElementById("fld_" + idx);
                    dv.classList.add('highlight');
                    
                    dv.onclick = function() { socket.send('{ "choice": ' + this.data + '}'); clearHighlight(); };
                }
            }
            if (msg.action === 'choosePlaceToSpade') {
                var dv = document.getElementById("input-box");
                dv.innerHTML = 'Choose a place to use spade. Spades left: ' + msg.amount;

                for (const pos of msg.possiblePos) {
                    var dv = document.getElementById("fld_" + pos);
                    dv.classList.add('highlight');
                    
                    dv.onclick = function() { socket.send('{ "choice": ' + this.data + '}'); clearHighlight(); };
                }
            }
            
        });
    </script>
    </head>
</html>